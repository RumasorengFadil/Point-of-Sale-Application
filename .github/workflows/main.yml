name: CI/CD

on:
  push:
    branches:
      - main # Ganti dengan branch yang sesuai untuk deployment
  pull_request:
    branches:
      - main

jobs:
  deploy:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout Code
            uses: actions/checkout@v3

          - name: Setup PHP
            uses: shivammathur/setup-php@v2
            with:
              php-version: 8.2
              tools: composer:v2
              
          - name: Setup SSH Key
            env:
              SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            run: |
              echo "${SSH_PRIVATE_KEY}" > id_rsa
              chmod 600 id_rsa

          - name: Deploy Static Files
            env:
              SERVER_IP: ${{ secrets.SERVER_IP }}
              SERVER_USER: ${{ secrets.SERVER_USER }}
            run: |
              scp -P 6510 -o StrictHostKeyChecking=no -i id_rsa -r ./public/* $SERVER_USER@$SERVER_IP:/home/bbytscom/rumasoreng.fadil
              scp -P 6510 -o StrictHostKeyChecking=no -i id_rsa -r ./public/.[!.]* bbytscom@119.235.250.57:/home/bbytscom/rumasoreng.fadil
    
          - name: Deploy Laravel Application
            env:
              SERVER_IP: ${{ secrets.SERVER_IP }}
              SERVER_USER: ${{ secrets.SERVER_USER }}
            run: |
              scp -P 6510 -o StrictHostKeyChecking=no -i id_rsa -r * $SERVER_USER@$SERVER_IP:/home/bbytscom/rumasoreng.fadil/laravel
              scp -P 6510 -o StrictHostKeyChecking=no -i id_rsa -r .[!.]* $SERVER_USER@$SERVER_IP:/home/bbytscom/rumasoreng.fadil/laravel
    
          - name: Run Post-Deploy Commands
            env:
              SERVER_IP: ${{ secrets.SERVER_IP }}
              SERVER_USER: ${{ secrets.SERVER_USER }}
            run: |
              ssh -p 6510 -o StrictHostKeyChecking=no -i id_rsa $SERVER_USER@$SERVER_IP "
                cd /home/bbytscom/rumasoreng.fadil/laravel && 
                composer install --prefer-dist --optimize-autoloader &&
                php artisan key:generate &&
                php artisan config:clear &&
                php artisan route:clear &&
                php artisan view:clear &&
                php artisan config:cache || echo 'Config cache failed' &&
                php artisan route:cache || echo 'Route cache failed' &&
                php artisan view:cache || echo 'View cache failed' &&
                php artisan optimize &&
                php artisan migrate:fresh --seed  || echo 'Migration failed'
              "

# ln -s /home/bbytscom/public_html/laravel/storage/app/public /home/bbytscom/public_html/storage 